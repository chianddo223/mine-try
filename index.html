<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Que pasa</title>
    <style>
        @font-face {
            font-family: 'CookieRun-Regular';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        table {
            border-collapse: collapse;
            background: #888;
        }

        td {
            font-family: 'CookieRun-Regular';
            font-size: 5.8vw;
            border: 1vw solid #bbb;
            text-align: center;
            line-height: 20px;
            width: 8vw;
            height: 8vw;
            background: #888;
        }

        td#mine {
            color: #888;
            background: #888;
        }
    </style>
</head>

<body>
<table id="table">
    <tbody>
    </tbody>
</table>
<form id="form">
    <input placeholder="ê°€ë¡œ ì¤„" id="row" size="5" />
    <input placeholder="ì„¸ë¡œ ì¤„" id="cell" size="5" />
    <input placeholder="ì§€ë¢°" id="mine" size="5" />
    <button>ê²Œì„ì‹œì‘</button>
</form>
<script>
const $tbody = document.querySelector('#table tbody');
const $inputRow = document.querySelector('#row');
const $inputCol = document.querySelector('#cell');
const $inputMine = document.querySelector('#mine');
const $btn = document.querySelector('button');
const rows = [];
const randomArray = [];
const mineArray = [];
let flattedArray = rows.flat();
let copyFlatted = flattedArray.concat();
let numRows = 0;
let numClos = 0;
let numRowsInt = 0;
let numClosInt = 0;
let numMine = 0;
let arrayWidth = 0;
$btn.addEventListener('click', startGame);
function startGame() {
    event.preventDefault();
    numRows = $inputRow.value; // ì„¸ë¡œ ê°’ 
    numClos = $inputCol.value; // ê°€ë¡œ ê°’
    numRowsInt = parseInt(numRows, 10);
    numClosInt = parseInt(numClos, 10);
    numMine = parseInt($inputMine.value);
    arrayWidth = numRows * numClos;
    for (let i = 0; i < numRows; i++) { // 2ì°¨ì›ë°°ì—´ ë§Œë“¤ê¸°.
        const $tr = document.createElement('tr');
        const cells = [];
        for (let j = 0; j < numClos; j++) { // ê°ê°ì˜ tdê°€ ìƒì„±ë˜ë©´ì„œ íŠ¹ì„±ë¶€ì—¬ë°›ìŒ.
            const $td = document.createElement('td');
            $td.addEventListener('click', onClick);
            $td.addEventListener('contextmenu', fillRed);
            $td.classList.add(i * 10 + j);
            cells.push($td);
            $tr.append($td);
        }
        rows.push(cells);
        $tbody.append($tr);
    };
    flattedArray = rows.flat();
    copyFlatted = flattedArray.concat();
    shuffleMine();
};
function shuffleMine() {
    // console.log(flattedArray)
    for (let i = 0; i < numMine; i++) { // ëœë¤ ì§€ë¢° ë°°ì—´ë§Œë“¤ê¸°.
        const randomIndex = flattedArray.splice(Math.floor(Math.random() * flattedArray.length), 1);
        randomArray.push(randomIndex);
    }
    const flattedRandom = randomArray.flat();
    for (let j = 0; j < numMine; j++) { // ì§€ë¢° ë°°ì—´ ë§Œë“¤ê³ , id, í…ìŠ¤íŠ¸ ë‹¬ì•„ì£¼ê¸°.
        mineArray.push(flattedRandom[j]);
        mineArray[j].id = "mine";
    }
}
function onClick() { // ê³µê°„ì„ í´ë¦­í–ˆì„ ë•Œ.
    if ( this.style.background === 'white') {
        return;
    }
    if (this.id === 'mine') { // ì§€ë¢°ì¼ ë•Œ 
        this.style.background = 'black';
        this.textContent = 'ğŸ’¥';
        defeat();
    } else { // ì§€ë¢°ê°€ ì•„ë‹ ë•Œ ì£¼ë³€ ì§€ë¢°ê°¯ìˆ˜ ì²´í¬.
        checkAround(this);
    };
    if( this.style.background === 'white'){
    const whiteBlock = copyFlatted.filter((item) => item.style.background === 'white');
    for( let i = 0; i < whiteBlock.length; i++){
        checkAround(whiteBlock[i]);
    };
    checkWin();
}
};
function fillRed() {
    if(this.style.background ==='white'){
        return;
    };
    event.preventDefault();
    if (this.textContent === 'ğŸš©') {
        this.style.background = '#888';
        this.textContent = '';
    } else {
         this.style.background = '#888';
        this.textContent = 'ğŸš©';
   };
};

function checkAround( clickedBlock ){ // ì£¼ë³€ì— ì§€ë¢°ê°¯ìˆ˜ ì²´í¬í•˜ê³  í‘œì‹œí•´ì¤Œ.
        const onClickClass = parseInt(clickedBlock.className);        
        const checkList = [];
        const leftSide = [];
        const rightSide = [];
        for (let i = 0; i < numClosInt; i++) {
            leftSide.push(numRowsInt * i);
        }
        for (let i = 0; i < numClosInt; i++) {
            rightSide.push((numRowsInt * (i+1))-1);
        }
        let classOfCheckList = [];
        switch (clickedBlock) { // ìƒˆì–´ ë‚˜ê°€ëŠ” ê²€ì‚¬ì¹¸ í•„í„°ë§ - ëª¨ì„œë¦¬
            case rows[0][0]:
                classOfCheckList = [onClickClass + 1, onClickClass + numRowsInt, onClickClass + numRowsInt + 1];
                break;
            case rows[0][numRowsInt-1]:
                classOfCheckList = [onClickClass -1, onClickClass + numRowsInt, onClickClass + numRowsInt - 1];
                break;
            case rows[numClosInt-1][0]:
                classOfCheckList = [parseInt(onClickClass) + 1 ,onClickClass -numRowsInt, parseInt(onClickClass -numRowsInt) + 1];
                break;
            case rows[numClosInt-1][numRowsInt-1]:
                classOfCheckList = [onClickClass -1, onClickClass - numRowsInt, onClickClass - numRowsInt -1];
                break;
            }
        if (rows[0].includes(clickedBlock) && classOfCheckList.length === 0 ) { // ìƒˆì–´ ë‚˜ê°€ëŠ” ê²€ì‚¬ì¹¸ í•„í„°ë§ - ê°€ì¥ìë¦¬
            classOfCheckList = [onClickClass + 1, onClickClass -1, onClickClass -1 + numRowsInt, onClickClass + numRowsInt, onClickClass + numRowsInt + 1];
        } else if(rows[numClosInt-1].includes(clickedBlock) && classOfCheckList.length === 0  ){
            classOfCheckList = [onClickClass + 1, onClickClass -1, onClickClass + 1 - numRowsInt, onClickClass -1 - numRowsInt, onClickClass -numRowsInt];
        } else if (leftSide.includes(onClickClass) && classOfCheckList.length === 0 ) {
            classOfCheckList = [onClickClass - numRowsInt, onClickClass - numRowsInt + 1, onClickClass + 1, onClickClass + numRowsInt, onClickClass + numRowsInt +1];
        } else if (rightSide.includes(onClickClass) && classOfCheckList.length === 0 ){
            classOfCheckList = [onClickClass - numRowsInt, onClickClass - numRowsInt -1, onClickClass -1, onClickClass + numRowsInt, onClickClass + numRowsInt -1];
        } else if (classOfCheckList.length === 0){
            classOfCheckList = [onClickClass - 11, onClickClass - 10, onClickClass - 9,
            onClickClass - 1, parseInt(onClickClass) + 1,
            parseInt(onClickClass) + 9, parseInt(onClickClass) + 10, parseInt(onClickClass) + 11];    
        };
        const filteredClass1 = classOfCheckList.filter( item => -1 < item && item< numRowsInt * numClosInt ); // ì‚ì ¸ë‚˜ê°€ëŠ” ê²€ì‚¬ ì¹¸ í•„í„°ë§.
        for (let i = 0; i < filteredClass1.length; i++) { // ì¡´ì¬í•˜ëŠ” ì¹¸ë§Œ í•„í„°ë§. 
            checkList.push(copyFlatted[filteredClass1[i]]);
        };
        // console.log(filteredClass1, checkList);
        const countMine = checkList.filter(item => item.id === "mine").length;
        // console.log(countMine);
        clickedBlock.textContent = countMine;
        clickedBlock.style.background = 'white';
        if (countMine === 0) { // 2ì°¨ ì ˆì°¨ (ì²˜ìŒ ëˆŒë¦° ì¹¸ì´ í° ì¹¸ì¼ ë•Œ ê·¸ ì£¼ë³€ì˜ ì£¼ë³€ì„ ê²€ì‚¬.)
            clickedBlock.textContent = ''; 
            let aroundCheckList = [];
            
            for (let j = 0; j < checkList.length; j++) { // ì„ íƒí•œ ì¹¸ì˜ ì£¼ë³€ ì¹¸ì˜, ì£¼ë³€ ì§€ë¢° ê°¯ìˆ˜ë¥¼ í™•ì¸í•¨. ë°˜ë³µë¬¸ì´ ì‹œí–‰ë  ë•Œ ë§ˆë‹¤ ì§€ë¢°ì˜ ìˆ˜ê°€ ìƒˆë¡­ê²Œ ê°±ì‹ ë˜ê³ , ì£¼ë³€ ì§€ë¢° ìˆ˜ê°€ 0ì¸ ì¹¸ì„ ë¹ˆ ì¹¸ìœ¼ë¡œ ë§Œë“¤ì–´ ì¤Œ.
                const aroundClass = parseInt(checkList[j].className);
                let aroundClassOfCheckList = [];
                switch (checkList[j]) { // ìƒˆì–´ ë‚˜ê°€ëŠ” ê²€ì‚¬ì¹¸ í•„í„°ë§ - ëª¨ì„œë¦¬
            case rows[0][0]:
                aroundClassOfCheckList = [aroundClass + 1, aroundClass + numRowsInt, aroundClass + numRowsInt + 1];
                break;
            case rows[0][numRowsInt-1]:
                aroundClassOfCheckList = [aroundClass -1, aroundClass + numRowsInt, aroundClass + numRowsInt - 1];
                break;
            case rows[numClosInt-1][0]:
                aroundClassOfCheckList = [aroundClass + 1 ,aroundClass -numRowsInt, aroundClass -numRowsInt + 1];
                break;
            case rows[numClosInt-1][numRowsInt-1]:
                aroundClassOfCheckList = [aroundClass -1, aroundClass - numRowsInt, aroundClass - numRowsInt -1];
                break;
            }
            
        if (rows[0].includes(checkList[j]) && aroundClassOfCheckList.length === 0 ) { // ìƒˆì–´ ë‚˜ê°€ëŠ” ê²€ì‚¬ì¹¸ í•„í„°ë§ - ê°€ì¥ìë¦¬
            aroundClassOfCheckList = [aroundClass + 1, aroundClass -1, aroundClass -1 + numRowsInt, aroundClass + numRowsInt, aroundClass + numRowsInt + 1];
        } else if(rows[numClosInt-1].includes(checkList[j]) && aroundClassOfCheckList.length === 0  ){
            aroundClassOfCheckList = [aroundClass + 1, aroundClass -1, aroundClass + 1 - numRowsInt, aroundClass -1 - numRowsInt, aroundClass -numRowsInt];
        } else if (leftSide.includes(aroundClass) && aroundClassOfCheckList.length === 0 ) {
            aroundClassOfCheckList = [aroundClass - numRowsInt, aroundClass - numRowsInt + 1, aroundClass + 1, aroundClass + numRowsInt, aroundClass + numRowsInt +1];
        } else if (rightSide.includes(aroundClass) && aroundClassOfCheckList.length === 0 ){
            aroundClassOfCheckList = [aroundClass - numRowsInt, aroundClass - numRowsInt -1, aroundClass -1, aroundClass + numRowsInt, aroundClass + numRowsInt -1];
        } else if( aroundClassOfCheckList.length === 0){
            aroundClassOfCheckList = [aroundClass - 11, aroundClass - 10, aroundClass - 9,
            aroundClass - 1, parseInt(aroundClass) + 1,
            parseInt(aroundClass) + 9, parseInt(aroundClass) + 10, parseInt(aroundClass) + 11];    
        };
        const filteredClass2 = aroundClassOfCheckList.filter( item => -1 < item && item < numRowsInt * numClosInt); // ì‚ì ¸ë‚˜ê°€ëŠ” ê²€ì‚¬ ì¹¸ í•„í„°ë§. 
        for (let k = 0; k < filteredClass2.length; k++) { // ì¡´ì¬í•˜ëŠ” ì¹¸ë§Œ í•„í„°ë§. 
            aroundCheckList.push(copyFlatted[filteredClass2[k]]);
        }; 
        const aroundCountMine = aroundCheckList.filter(item => item.id === "mine").length;
        copyFlatted[aroundClass].textContent = aroundCountMine;
        if( aroundCountMine === 0 ){ // ì£¼ë³€ì— ì§€ë¢°ê°€ ì—†ëŠ” ë•… ë°œê²¬ ì‹œ.
            copyFlatted[aroundClass].textContent = '';
        }
        copyFlatted[aroundClass].style.background = 'white';
        aroundCheckList = [];
       }
    }
}

function checkWin(){
    const allMine = copyFlatted.filter(item => item.id === 'mine'); 
    const blank = copyFlatted.filter(item => item.id !== "mine");
    const noBlank = blank.every(item => item.style.background === 'white');
    if(noBlank){
        allMine.forEach((mine, index) => {
            setTimeout(() => {
                mine.textContent = 'ğŸ’¥';
                mine.style.transition = 'opacity 1s ease-in-out';
                mine.style.opacity = 0;
            }, 1000 + index * 200); // ê° ì§€ë¢°ë§ˆë‹¤ 0.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
        });

        setTimeout(() => {
            allMine.forEach(mine => {
                mine.style.opacity = 1;
            });
        }, allMine.length * 200 + 3000); // ëª¨ë“  ì§€ë¢°ê°€ í‘œì‹œëœ í›„ 3ì´ˆ ëŒ€ê¸°

        setTimeout(() => {
            allMine.forEach(mine => {
                mine.style.opacity = 0;
            })
        }, allMine.length * 200 + 5000);

        setTimeout(() => {
            allMine.forEach(mine => {
                mine.textContent = 'ğŸ‰';
                mine.style.opacity = 1;
            })
        }, allMine.length * 200 + 6000);
        setTimeout(() => {
            const confirm = window.confirm('ìŠ¹ë¦¬ !! \nê²Œì„ì„ ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if(confirm){
              reGame();
              };
        }, allMine.length * 200 + 7000);
    };
}
const randomMine = [];
function defeat(){
    const allMine = copyFlatted.filter(item => item.id === 'mine'); 
    for( let i = 0; i< numMine; i++){
        const randomIndex = allMine.splice(Math.floor(allMine.length * Math.random()), 1);
        randomMine.push(randomIndex[0]);
    };
    console.log(randomMine)
    randomMine.forEach((mine, index) => {
            setTimeout(() => {
                mine.textContent = 'ğŸ’¥';
                mine.style.background = 'black';
                mine.style.transition = 'opacity 1s ease-in-out';
                mine.style.opacity = 1;
            }, 1000 + index * 200); // ê° ì§€ë¢°ë§ˆë‹¤ 0.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
        });
        setTimeout(()=>{
            const confirm = window.confirm('íŒ¨ë°° ã… ã…  \nê²Œì„ì„ ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if(confirm){
            reGame();
        };
        }, 1000 + randomMine.length * 200);
       
}
function reGame(){
    location.reload();
};
</script>
</body>

</html>
